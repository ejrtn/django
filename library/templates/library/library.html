<!DOCTYPE html>
<html lang="en">

<head>
  <title></title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/library/library.css">
  <script src="http://code.jquery.com/jquery-latest.min.js"></script>
  <script>
    
    // using jQuery
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = jQuery.trim(cookies[i]);
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) == (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $(document).ready(function () {
      var csrftoken = getCookie('csrftoken');
      $.ajaxSetup({
        beforeSend: function (xhr, settings) {
          if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
          }
        }
      });
    });
  </script>
  <script>
    function book_type_list_ui(data) {
      data = data['result']
      document.getElementById('booktypelsit').innerHTML = "";
          
      for (let i = 0; i < data.length; i++) {
        if(i===0){
          $("#booktypelsit").append('<li class="book_type_name background_color_yellow">' + data[i].book_type + '<img src="/static/images/del.png" alt="' + data[i].id + '" class="del"></li>')
        }else{
          $("#booktypelsit").append('<li class="book_type_name background_color_white">' + data[i].book_type + '<img src="/static/images/del.png" alt="' + data[i].id + '" class="del"></li>')
        }
        document.getElementsByClassName('del')[i].addEventListener('click', function (e) {
          book_type_del(e.target.alt)
        })
        document.getElementsByClassName('book_type_name')[i].addEventListener('click', function (e) {
          el = document.getElementsByClassName('book_type_name')
          for(let l=0;l<el.length;l++){el[l].className='book_type_name background_color_white'}
          e.target.className='book_type_name background_color_yellow'
        })
      }
    }
    $(function () {
      BookListUi();
      $.ajax({
        method: "POST",
        url: "/library/BookTypeList/",
        data: JSON.stringify({
          'X-CSRFTOKEN': '{{ csrf_token }}'
        }),
        success: function (data) {
          book_type_list_ui(data)
        },
        error: function (error) {
          console.log(error)
        }
      })
      document.getElementById('booktypetextbtn').addEventListener('click', function () {
        $.ajax({
          method: "POST",
          url: "/library/BookTypeSave/",
          dataType: 'json',
          data: JSON.stringify({ 'X-CSRFTOKEN': '{{ csrf_token }}', 'book_type': document.getElementById('booktypetext').value }),
          success: function (data) {
            book_type_list_ui(data)
          },
          error: function (error) {
            console.log(error)
          }
        })
      })
      document.getElementById('booksavebtn').addEventListener('click',function(){
        const el = document.querySelectorAll(".book_type_name img");
        let book_type_id = null
        for(l=0;l<el.length;l++){
          if(el[l].parentNode.className.includes('background_color_yellow')){
            book_type_id = el[l].alt
          }
        }
        $.ajax({
          method: "POST",
          url: "/library/BookSave/",
          data: JSON.stringify({ 
            'X-CSRFTOKEN': '{{ csrf_token }}' , 
            'book_type_id':parseInt(book_type_id),
            'book_name':document.getElementById('booknametext').value,
            'book_writer':document.getElementById('bookwritertext').value,
            'count':parseInt(document.getElementById('bookcounttext').value)
          }),
          success: function (data) {
            BookListUi()
          },
          error: function (error) {
            console.log(error)
          }
        })
      })
    })
    function book_type_del(id) {
      $.ajax({
        method: "POST",
        url: "/library/BookTypeDel/",
        dataType: 'json',
        data: JSON.stringify({ 'X-CSRFTOKEN': '{{ csrf_token }}', 'book_type_id': id }),
        success: function (data) {
          book_type_list_ui(data)
        },
        error: function (error) {
          console.log(error)
        }
      })
    }
    function BookListUi(){
      $.ajax({
        method: "POST",
        url: "/library/BookList/",
        data: JSON.stringify({
          'X-CSRFTOKEN': '{{ csrf_token }}'
        }),
        success: function (data) {
          data = JSON.parse(data['result'])
          let t = ''
          console.log(data)
          for(i=0;i<data.length;i++){
            t += '<tr>'
            t += '<td style="text-align: center;border-bottom: 1px solid #777;">'+data[i].fields.bookType+'</td>'
            t += '<td style="text-align: center;border-bottom: 1px solid #777;">'+data[i].fields.book_name+'</td>'
            t += '<td style="text-align: center;border-bottom: 1px solid #777;">'+data[i].fields.book_writer+'</td>'
            t += '<td style="text-align: center;border-bottom: 1px solid #777;">'+data[i].fields.count+'</td>'
            t += '</tr>'
          }
          document.querySelector('.main_table tbody').innerHTML=t
        },
        error: function (error) {
          console.log(error)
        }
      })
    }
  </script>
</head>

<body>
  <h1>Library Admin</h1>
  
  <div style="display: flex;">
    <div style="margin-right: 100px;">
      <h1>Book Type</h1>
      <input type="text" style="height: 25px;" id="booktypetext">
      <input type="button" style="height: 28px;" value="추가" id="booktypetextbtn">
      <div style="margin-top: 5px;">
        <div id="booktypelsit" style="border: 1px solid black; padding: 10px;width: 100px;max-height: 200px;overflow-y: auto;"></div>
      </div>
    </div>

    <div>
      <h1>Book Name</h1>
      제목 : <input type="text" style="height: 25px;" id="booknametext">
      저자 : <input type="text" style="height: 25px;" id="bookwritertext">
      갯수 : <input type="text" style="height: 25px;" id="bookcounttext">
      <input type="button" style="height: 28px;" value="추가" id="booksavebtn">
      
      <table class="main_table">
        <thead>
        <tr>
          <th style="width:300px;border-bottom: 1px solid #777;">유형</th>
          <th style="width:300px;border-bottom: 1px solid #777;">제목</th>
          <th style="width:300px;border-bottom: 1px solid #777;">저자</th>
          <th style="width:100px;border-bottom: 1px solid #777;">갯수</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
  </div>
</body>

</html>